<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consumo de aguá (Lite)</title>
  <meta name="description" content="Versão simples para acompanhar o consumo diário de água, com gráfico compacto e layout limpo."/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .scrollbar-thin { scrollbar-width: thin; }
    .scrollbar-thin::-webkit-scrollbar { height: 8px; width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 9999px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-3xl mx-auto p-4">
    <header class="mb-4">
      <h1 class="text-xl font-bold">Consumo de aguá</h1>
      <p class="text-sm text-slate-500">Versão simples (gráfico compacto e seções com altura fixa para evitar rolagem excessiva).</p>
    </header>

    <!-- Controles -->
    <section class="bg-white rounded-xl shadow border border-slate-100 p-3 mb-4">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <label class="block text-xs text-slate-500">Limite diário (L)</label>
          <input id="limite" type="number" min="0" step="1" class="w-full px-3 py-2 rounded-lg border border-slate-200" value="250">
        </div>
        <div>
          <label class="block text-xs text-slate-500">Data</label>
          <input id="data" type="date" class="w-full px-3 py-2 rounded-lg border border-slate-200">
        </div>
        <div>
          <label class="block text-xs text-slate-500">Leitura (L)</label>
          <div class="flex gap-2">
            <input id="leitura" type="number" min="0" step="1" class="flex-1 px-3 py-2 rounded-lg border border-slate-200" placeholder="Ex.: 180">
            <button id="add" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm">Adicionar</button>
          </div>
        </div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="export" class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">Exportar JSON</button>
        <label class="px-3 py-2 rounded-lg bg-white border border-slate-200 text-sm cursor-pointer">
          Importar JSON
          <input id="import" type="file" accept="application/json" class="hidden">
        </label>
        <button id="reset" class="px-3 py-2 rounded-lg bg-white border border-rose-200 text-rose-600 text-sm">Resetar</button>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-3 gap-3 mb-4">
      <div class="bg-white rounded-xl shadow border border-slate-100 p-3">
        <p class="text-xs text-slate-500">Total (L)</p>
        <p id="k_total" class="text-lg font-semibold">0</p>
      </div>
      <div class="bg-white rounded-xl shadow border border-slate-100 p-3">
        <p class="text-xs text-slate-500">Média (L/dia)</p>
        <p id="k_media" class="text-lg font-semibold">0</p>
      </div>
      <div class="bg-white rounded-xl shadow border border-slate-100 p-3">
        <p class="text-xs text-slate-500">Limite (L)</p>
        <p id="k_limite" class="text-lg font-semibold">250</p>
      </div>
    </section>

    <!-- Gráfico compacto (altura fixa) -->
    <section class="bg-white rounded-xl shadow border border-slate-100 p-3 mb-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-base font-semibold">Histórico de Consumo</h2>
        <span id="alerta" class="hidden text-xs px-2 py-1 rounded-lg bg-amber-100 text-amber-800 border border-amber-200">Acima do limite</span>
      </div>
      <div class="h-56"> <!-- ~224px, evita crescer sem fim -->
        <canvas id="chart"></canvas>
      </div>
    </section>

    <!-- Tabela com altura fixa e rolagem interna -->
    <section class="bg-white rounded-xl shadow border border-slate-100">
      <div class="p-3">
        <h2 class="text-base font-semibold">Leituras</h2>
        <p class="text-xs text-slate-500">Tabela compacta; remova entradas quando necessário.</p>
      </div>
      <div class="max-h-56 overflow-auto scrollbar-thin">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-slate-600 sticky top-0">
            <tr>
              <th class="text-left p-2">Data</th>
              <th class="text-left p-2">Leitura (L)</th>
              <th class="text-left p-2">Status</th>
              <th class="text-left p-2">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </section>

    <footer class="text-center text-xs text-slate-500 my-6">
      <p>Dados salvos no navegador (localStorage). Publique este arquivo como <strong>index.html</strong> no GitHub Pages para obter um link permanente.</p>
    </footer>
  </div>

  <script>
    const KEY = "consumo_agua_lite_v1";
    let state = load();
    const qs = (sel) => document.querySelector(sel);

    // Inputs
    const $limite = qs("#limite");
    const $data = qs("#data");
    const $leitura = qs("#leitura");
    const $add = qs("#add");
    const $export = qs("#export");
    const $import = qs("#import");
    const $reset = qs("#reset");

    // KPIs
    const $k_total = qs("#k_total");
    const $k_media = qs("#k_media");
    const $k_limite = qs("#k_limite");
    const $alerta = qs("#alerta");

    // Tabela
    const $tbody = qs("#tbody");

    // Chart
    const ctx = document.getElementById("chart").getContext("2d");
    let chart;

    // Defaults
    function load() {
      try {
        const raw = localStorage.getItem(KEY);
        if (raw) return JSON.parse(raw);
      } catch {}
      const today = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      function dstr(dt){ return dt.getFullYear()+"-"+pad(dt.getMonth()+1)+"-"+pad(dt.getDate()); }
      const seed = [];
      for (let i=6;i>=0;i--) {
        const d = new Date(today);
        d.setDate(today.getDate()-i);
        seed.push({date: dstr(d), litros: 180 + Math.round(Math.random()*80)});
      }
      return { limite: 250, leituras: seed };
    }

    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

    // Init date input
    $data.valueAsDate = new Date();
    $limite.value = state.limite;
    $k_limite.textContent = state.limite;

    // Render
    function renderKPIs() {
      const total = state.leituras.reduce((a, b) => a + b.litros, 0);
      const dias = state.leituras.length || 1;
      const media = Math.round(total / dias);
      $k_total.textContent = total.toFixed(0);
      $k_media.textContent = media.toFixed(0);
      const last = state.leituras.at(-1)?.litros ?? null;
      if (last !== null && last > state.limite) $alerta.classList.remove("hidden");
      else $alerta.classList.add("hidden");
    }

    function renderTable() {
      $tbody.innerHTML = "";
      state.leituras.sort((a,b)=>a.date.localeCompare(b.date));
      state.leituras.forEach((l, i) => {
        const tr = document.createElement("tr");

        const tdD = document.createElement("td"); tdD.className = "p-2"; tdD.textContent = l.date;
        const tdL = document.createElement("td"); tdL.className = "p-2"; tdL.textContent = l.litros;
        const tdS = document.createElement("td"); tdS.className = "p-2";
        tdS.innerHTML = l.litros > state.limite
          ? '<span class="px-2 py-0.5 rounded bg-amber-100 text-amber-800 text-xs border border-amber-200">Acima</span>'
          : '<span class="px-2 py-0.5 rounded bg-emerald-100 text-emerald-800 text-xs border border-emerald-200">OK</span>';

        const tdA = document.createElement("td"); tdA.className = "p-2";
        const del = document.createElement("button");
        del.className = "px-2 py-1 rounded bg-white border border-slate-200 hover:bg-slate-50";
        del.textContent = "Remover";
        del.addEventListener("click", () => { state.leituras.splice(i,1); persist(); });
        tdA.appendChild(del);

        tr.append(tdD, tdL, tdS, tdA);
        $tbody.appendChild(tr);
      });
    }

    function renderChart() {
      const labels = state.leituras.map(l => l.date);
      const data = state.leituras.map(l => l.litros);
      const lim = state.limite;

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Leitura (L)", data, borderWidth: 2, tension: 0.2, pointRadius: 2 },
            { label: "Limite (L)", data: labels.map(()=>lim), borderWidth: 1, borderDash: [6,6], pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true, // usa a altura do container (.h-56)
          animation: false,
          plugins: { legend: { display: true, position: "bottom" } },
          scales: { x: { ticks: { autoSkip: true } }, y: { beginAtZero: true } }
        }
      });
    }

    function renderAll(){ renderKPIs(); renderTable(); renderChart(); }
    function persist(){ save(); renderAll(); }

    function addLeitura() {
      const d = $data.value;
      const v = Number($leitura.value);
      if (!d) { alert("Selecione a data."); return; }
      if (!Number.isFinite(v) || v < 0) { alert("Informe um número válido."); return; }
      const ex = state.leituras.find(x => x.date === d);
      if (ex) ex.litros = Math.round(v);
      else state.leituras.push({ date: d, litros: Math.round(v) });
      $leitura.value = "";
      persist();
    }

    // Events
    $add.addEventListener("click", addLeitura);
    $leitura.addEventListener("keydown", e => { if (e.key === "Enter") addLeitura(); });
    $limite.addEventListener("change", () => {
      const v = Number($limite.value);
      if (Number.isFinite(v) && v >= 0) {
        state.limite = Math.round(v);
        $k_limite.textContent = state.limite;
        persist();
      }
    });
    $export.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "consumo_agua_dados.json"; a.click();
      URL.revokeObjectURL(url);
    });
    $import.addEventListener("change", async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      try {
        const text = await file.text(); const data = JSON.parse(text);
        if (typeof data?.limite === "number" && Array.isArray(data?.leituras)) {
          state = data; persist();
        } else alert("JSON inválido.");
      } catch { alert("Falha ao importar JSON."); }
      finally { e.target.value = ""; }
    });
    $reset.addEventListener("click", () => {
      if (!confirm("Apagar todos os dados?")) return;
      localStorage.removeItem(KEY);
      state = load();
      renderAll();
    });

    // Inicializa
    renderAll();
  </script>
</body>
</html>
